<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ metadata.title | default("__TITLE__") }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-8">

      <nav class="mb-6 print:hidden">
        <a href="index.html"
           class="inline-flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow text-orange-600 hover:text-orange-700 hover:shadow-md transition-all font-medium text-sm">
          ‚Üê All Recipes
        </a>
      </nav>

      <div class="mb-8">
        {% if metadata.image %}
        <div class="mb-6 flex justify-center relative inline-block">
          <div class="relative">
            <img src="{{ metadata.image }}" alt="{{ metadata.title | default("__TITLE__") }}"
                 loading="lazy" class="rounded-xl shadow-lg max-w-full h-auto max-h-[500px]">
            {% if metadata.ai_image %}
            <span class="absolute top-2 right-2 text-xs bg-black/50 text-white px-2 py-0.5 rounded-full">‚ú® AI image</span>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
          <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-orange-600 to-yellow-600 bg-clip-text text-transparent">
            {{ metadata.title | default("__TITLE__") }}
          </h1>
          <button onclick="window.print()"
                  class="print:hidden self-start px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all shadow-md flex items-center gap-2 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
            </svg>
            Print
          </button>
        </div>

        <!-- Tags (split and rendered by JS below) -->
        {% if metadata.tags %}
        <div id="tags-container" class="flex flex-wrap gap-2 mb-4" data-tags="{{ metadata.tags }}"></div>
        {% endif %}

        <!-- Metadata pills -->
        <div class="flex flex-wrap gap-3 mb-6">
          {% if metadata.servings %}
          <div id="servings-scaler" data-servings="{{ metadata.servings }}"
               class="metadata-pill flex items-center gap-1 print:hidden">
            <span>üë•</span>
            <button id="servings-down" aria-label="Fewer servings"
                    class="w-5 h-5 rounded-full bg-orange-100 hover:bg-orange-200 text-orange-700 font-bold text-sm flex items-center justify-center transition-colors">‚àí</button>
            <span id="servings-display" class="min-w-max"></span>
            <button id="servings-up" aria-label="More servings"
                    class="w-5 h-5 rounded-full bg-orange-100 hover:bg-orange-200 text-orange-700 font-bold text-sm flex items-center justify-center transition-colors">+</button>
          </div>
          <span class="metadata-pill hidden print:inline">üë• {{ metadata.servings }}</span>
          {% endif %}
          {% if metadata["cook time"] %}
          <span class="metadata-pill">üî• {{ metadata["cook time"] }}</span>
          {% endif %}
          {% if metadata["time required"] %}
          <span class="metadata-pill">‚è±Ô∏è {{ metadata["time required"] }}</span>
          {% endif %}
          {% if metadata.author %}
          <span class="metadata-pill">üë§ {{ metadata.author }}</span>
          {% endif %}
          {% if metadata.source %}
          <span id="source-pill" data-source="{{ metadata.source }}" class="metadata-pill"></span>
          {% endif %}
        </div>
      </div>

      <!-- Two-column layout -->
      <div class="grid md:grid-cols-3 gap-8 mb-12">

        <!-- Ingredients + Cookware sidebar -->
        <div class="md:col-span-1">
          <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-4">
            <h2 class="text-xl font-bold mb-4 text-orange-600">ü•ò Ingredients</h2>
            <ul class="space-y-3">
              {% for ingredient in ingredients %}
              <li class="flex justify-between items-center bg-gradient-to-r from-orange-50 to-yellow-50 rounded-lg px-3 py-2">
                <span class="font-medium">{{ ingredient.name }}</span>
                <span class="ingredient-qty text-orange-700 font-semibold ml-2 text-sm"
                      data-qty="{% if ingredient.quantity %}{{ ingredient.quantity.value }}{% endif %}"
                      data-unit="{% if ingredient.quantity %}{% if ingredient.quantity.unit %}{{ ingredient.quantity.unit }}{% endif %}{% endif %}">
                  {% if ingredient.quantity %}{{ ingredient.quantity.value }}{% if ingredient.quantity.unit %} {{ ingredient.quantity.unit }}{% endif %}{% endif %}
                </span>
              </li>
              {% endfor %}
            </ul>

            {% if cookware %}
            <h2 class="text-xl font-bold mt-6 mb-4 text-green-600">üç≥ Cookware</h2>
            <ul class="space-y-2">
              {% for item in cookware %}
              <li class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg px-3 py-2">
                <span class="font-medium">{{ item.name }}</span>
              </li>
              {% endfor %}
            </ul>
            {% endif %}
          </div>
        </div>

        <!-- Steps -->
        <div class="md:col-span-2">
          <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-6 text-gray-800">üìù Instructions</h2>
            {% for section in sections %}
            <div class="instructions-raw hidden">{{ section }}</div>
            {% endfor %}
            <div id="steps-output"></div>
          </div>
        </div>

      </div>

      {% if metadata.notes %}
      <div class="bg-amber-50 border border-amber-200 rounded-2xl p-6 mb-12">
        <h2 class="text-lg font-bold mb-2 text-amber-800">üìå Notes</h2>
        <p class="text-amber-900 leading-7">{{ metadata.notes }}</p>
      </div>
      {% endif %}

    </div>

    <footer class="text-center py-6 text-gray-500 text-sm print:hidden">
      Generated with <a href="https://cooklang.org" target="_blank"
        class="text-orange-600 hover:text-orange-700">Cooklang</a>
    </footer>

    <script>
    (function () {
      // Render source as link or plain text depending on whether it's a URL
      const sourcePill = document.getElementById('source-pill');
      if (sourcePill) {
        const src = sourcePill.getAttribute('data-source') || '';
        if (src.startsWith('http://') || src.startsWith('https://')) {
          sourcePill.outerHTML = '<a href="' + src + '" target="_blank" class="metadata-pill hover:bg-orange-50 hover:border-orange-300 hover:text-orange-700 transition-colors">üìñ Source ‚Üó</a>';
        } else {
          sourcePill.textContent = 'üìñ ' + src;
        }
      }

      // Render tags from comma-separated string
      const tagsContainer = document.getElementById('tags-container');
      if (tagsContainer) {
        const raw = tagsContainer.getAttribute('data-tags') || '';
        tagsContainer.innerHTML = raw.split(',').map(function (t) {
          const tag = t.trim();
          return tag ? '<span class="tag">#' + tag + '</span>' : '';
        }).join('');
      }
    })();

    (function () {
      function escapeHtml(str) {
        return str
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;');
      }

      // Build ingredient data from already-rendered sidebar spans
      var ingredientData = [];
      document.querySelectorAll('.ingredient-qty').forEach(function (qtySpan) {
        var li = qtySpan.closest('li');
        var nameSpan = li && li.querySelector('.font-medium');
        var qty = parseFloat(qtySpan.getAttribute('data-qty'));
        var unit = qtySpan.getAttribute('data-unit') || '';
        var name = nameSpan ? nameSpan.textContent.trim() : '';
        if (name && !isNaN(qty)) {
          ingredientData.push({ name: name, qty: qty, unit: unit });
        }
      });

      function escRegex(s) {
        return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      // Wrap ingredient quantities in step text with scalable spans.
      // Called after escapeHtml so the text is safe; span tags are injected as real HTML.
      function annotateStep(html) {
        ingredientData.forEach(function (ing) {
          var qtyStr = String(ing.qty);
          var qtyEsc = escRegex(qtyStr);
          var span, re;
          if (ing.unit) {
            re = new RegExp('\\b' + qtyEsc + '\\s+' + escRegex(ing.unit) + '\\b', 'g');
            span = '<span class="step-qty" data-qty="' + ing.qty + '" data-unit="' + ing.unit + '">' + qtyStr + ' ' + ing.unit + '</span>';
            html = html.replace(re, span);
          } else {
            // No unit: match quantity only when immediately followed by the ingredient name
            var firstWord = escRegex(ing.name.split(/\s+/)[0]);
            re = new RegExp('\\b' + qtyEsc + '(?=\\s+' + firstWord + '\\b)', 'g');
            span = '<span class="step-qty" data-qty="' + ing.qty + '" data-unit="">' + qtyStr + '</span>';
            html = html.replace(re, span);
          }
        });
        return html;
      }

      const container = document.getElementById('steps-output');
      const rawDivs = document.querySelectorAll('.instructions-raw');
      let html = '';

      rawDivs.forEach(function (div) {
        const text = div.textContent || '';
        // Split into paragraphs
        const paragraphs = text.split(/\n{2,}/).map(p => p.trim()).filter(Boolean);

        let sectionName = null;
        let steps = [];

        paragraphs.forEach(function (para) {
          if (para.startsWith('= ')) {
            sectionName = para.slice(2).trim();
          } else if (/^\d+\.\s/.test(para)) {
            steps.push(para.replace(/^\d+\.\s*/, ''));
          }
        });

        if (sectionName) {
          html += '<h3 class="text-lg font-semibold mt-6 mb-4 text-orange-700 border-b-2 border-orange-100 pb-2">' +
            escapeHtml(sectionName) + '</h3>';
        }

        if (steps.length > 0) {
          html += '<ol class="space-y-4">';
          steps.forEach(function (step, i) {
            html += '<li class="bg-gradient-to-r from-gray-50 to-orange-50 rounded-xl p-4">' +
              '<div class="flex gap-4">' +
              '<div class="step-number">' + (i + 1) + '</div>' +
              '<div class="flex-1 text-gray-700 leading-8">' + annotateStep(escapeHtml(step)) + '</div>' +
              '</div>' +
              '</li>';
          });
          html += '</ol>';
        } else if (!sectionName) {
          // Fallback: plain text block
          html += '<p class="text-gray-700 leading-8 whitespace-pre-wrap">' + escapeHtml(text.trim()) + '</p>';
        }
      });

      container.innerHTML = html;
    })();
    </script>

    <script>
    (function () {
      const scaler = document.getElementById('servings-scaler');
      if (!scaler) return;

      const raw = scaler.getAttribute('data-servings') || '';
      const match = raw.match(/^(\d+(?:\.\d+)?)(.*)/);
      if (!match) return;

      const originalServings = parseFloat(match[1]);
      const suffix = match[2].trim(); // e.g. "footlong's" or ""
      let current = originalServings;

      const display = document.getElementById('servings-display');
      const downBtn = document.getElementById('servings-down');
      const upBtn = document.getElementById('servings-up');

      function formatQty(val) {
        if (val <= 0) return '0';
        const whole = Math.floor(val);
        const rem = val - whole;
        if (rem < 0.01) return String(whole);
        const fracs = [[1,8],[1,4],[1,3],[3,8],[1,2],[5,8],[2,3],[3,4],[7,8]];
        for (const [n, d] of fracs) {
          if (Math.abs(rem - n / d) < 0.025) {
            const f = n + '/' + d;
            return whole > 0 ? whole + ' ' + f : f;
          }
        }
        return parseFloat(val.toFixed(2)).toString();
      }

      function updateDisplay() {
        display.textContent = current + (suffix ? ' ' + suffix : ' servings');
      }

      function scaleIngredients() {
        const factor = current / originalServings;
        document.querySelectorAll('.ingredient-qty, .step-qty').forEach(function (el) {
          const qty = parseFloat(el.getAttribute('data-qty'));
          if (isNaN(qty)) return;
          const unit = el.getAttribute('data-unit') || '';
          el.textContent = formatQty(qty * factor) + (unit ? ' ' + unit : '');
        });
      }

      function onChange() {
        updateDisplay();
        scaleIngredients();
        const url = new URL(window.location.href);
        if (current === originalServings) {
          url.searchParams.delete('servings');
        } else {
          url.searchParams.set('servings', current);
        }
        history.replaceState(null, '', url.toString());
      }

      // Restore servings from URL parameter
      const urlServings = parseInt(new URLSearchParams(window.location.search).get('servings'), 10);
      if (!isNaN(urlServings) && urlServings > 0) { current = urlServings; }

      downBtn.addEventListener('click', function () {
        if (current > 1) { current--; onChange(); }
      });
      upBtn.addEventListener('click', function () {
        current++; onChange();
      });

      updateDisplay();
      scaleIngredients(); // convert decimals to nice fractions on load (and apply URL param)
    })();
    </script>
  </body>
</html>
